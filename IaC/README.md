# Infrastructure as Code (IaC)

This directory contains the Azure Bicep templates for deploying the AzSRE Agent infrastructure.

## Structure

```
IaC/
├── main.bicep                    # Main deployment file
├── parameters.example.json       # Example parameters file
├── modules/                      # Reusable Bicep modules
│   ├── container-apps-environment.bicep
│   ├── container-registry.bicep
│   ├── container-app.bicep
│   ├── log-analytics-workspace.bicep
│   └── application-insights.bicep
└── README.md                     # This file
```

## Modules

### container-apps-environment.bicep
Creates a Container Apps Environment with support for both Consumption and GPU workload profiles.

### container-registry.bicep
Creates an Azure Container Registry with scope maps for different access levels.

### container-app.bicep
Reusable module for creating Container Apps. Used for both the main AzSRE Agent app and the Ollama service.

### log-analytics-workspace.bicep
Creates a Log Analytics Workspace for centralized logging and monitoring.

### application-insights.bicep
Creates an Application Insights component with proactive detection configurations enabled.

## Deployment

### Prerequisites

1. Azure CLI installed and configured
2. Bicep CLI installed
3. Appropriate Azure permissions to create resources

### Quick Start

1. Copy the example parameters file:
   ```bash
   cp parameters.example.json parameters.json
   ```

2. Edit `parameters.json` with your values. All parameters are required and have no defaults to ensure security and avoid exposing sensitive information.

3. Deploy using Azure CLI:
   ```bash
   az deployment group create \
     --resource-group <your-resource-group> \
     --template-file main.bicep \
     --parameters @parameters.json
   ```

### Required Parameters

All parameters are required and have no default values to ensure security and avoid exposing sensitive information in the repository. You must provide values for:

- `subscriptionId`: Azure subscription ID
- `location`: Azure region for deployment
- `containerAppsEnvironmentName`: Container Apps Environment name
- `containerRegistryName`: Container registry name (globally unique)
- `mainContainerAppName`: Main container app name
- `ollamaContainerAppName`: Ollama container app name
- `applicationInsightsName`: Application Insights component name
- `logAnalyticsWorkspaceName`: Log Analytics workspace name
- `logWorkspaceId`: Log Analytics workspace customer ID
- `mainAppImageName`: Container image name for main app
- `imageTag`: Container image tag
- `ollamaModelTriage`: Ollama model name for triage
- `ollamaModelAnalysis`: Ollama model name for analysis
- `ollamaModelDatabase`: Ollama model name for database
- `ollamaModelReporter`: Ollama model name for reporter
- `ollamaModelMain`: Ollama model name for main
- `gpuWorkloadProfileName`: Workload profile name for GPU workloads
- `mainAppCpu`: Main app container CPU allocation
- `mainAppMemory`: Main app container memory allocation
- `mainAppTargetPort`: Main app target port
- `ollamaAppCpu`: Ollama app container CPU allocation
- `ollamaAppMemory`: Ollama app container memory allocation
- `ollamaAppTargetPort`: Ollama app target port
- `minReplicas`: Minimum number of replicas
- `maxReplicas`: Maximum number of replicas
- `mainContainerName`: Main app container name

## Customization

### Changing Resource Locations

Update the `location` parameter in `parameters.json`. Supported values include:
- `UK South`
- `uksouth`
- `eastus`
- `westus`
- `westeurope`
- `northeurope`

### Adjusting Resource Sizes

Modify the following parameters in `parameters.json`:
- `mainAppCpu`: CPU allocation for main app (e.g., "0.5", "1", "2")
- `mainAppMemory`: Memory allocation for main app (e.g., "1Gi", "2Gi")
- `ollamaAppCpu`: CPU allocation for Ollama (integer, e.g., 2, 4)
- `ollamaAppMemory`: Memory allocation for Ollama (e.g., "8Gi", "16Gi")

### Scaling Configuration

Adjust scaling behavior:
- `minReplicas`: Minimum number of replicas (default: 0)
- `maxReplicas`: Maximum number of replicas (default: 10)

## Outputs

The deployment outputs the following resource IDs and identifiers:
- Container Apps Environment ID and name
- Container Registry ID and login server
- Log Analytics Workspace ID and customer ID
- Application Insights ID, instrumentation key, and app ID
- Main Container App ID
- Ollama Container App ID

## Notes

- The original Bicep file included many saved searches and tables for Log Analytics. These are typically auto-generated by Azure and have been excluded from the modularized version. If you need specific saved searches, you can add them as additional resources or create a separate module.

- Container registry names must be globally unique across all Azure subscriptions.

- The Container Apps Environment uses both Consumption and GPU workload profiles. Ensure your subscription has access to GPU-enabled SKUs if you plan to use the GPU profile.

